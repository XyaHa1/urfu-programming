from .characters import CharacterFactory, Dragon, DragonManager

from .utils import custom_output, print_health_bar

story = """–í –¥–∞–ª—ë–∫–æ–π –¥–æ–ª–∏–Ω–µ –†–∞–¥–∏—Å—Ç—Ä–∏–∏, –≥–¥–µ —Å–æ–ª–Ω—Ü–µ –ª–∞—Å–∫–∞–µ—Ç —Ö–æ–ª–º—ã, –∞ —Ä–µ–∫–∏ –ø–æ—é—Ç –¥—Ä–µ–≤–Ω–∏–µ
–ø–µ—Å–Ω–∏, –ø—Ä–æ—Ü–≤–µ—Ç–∞–ª–∞ –¥–µ—Ä–µ–≤–Ω—è –ü–∏—Ç–æ–Ω–∏—è. –ù–æ –≤–æ—Ç —É–∂–µ —Ç—Ä–µ—Ç–∏–π –º–µ—Å—è—Ü –Ω–µ–±–æ —Å–µ—Ä–æ, –∞ –ø–æ–ª—è
–ø—É—Å—Ç—ã ‚Äî –Ω–∞–ª–µ—Ç–µ–ª –í–µ–ª–∏–∫–∏–π –ì–æ–ª–æ–¥. –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –Ω–∞–¥–µ–∂–¥–∞ ‚Äî –∑–∞–ø–∞—Å—ã —Ñ—Ä—É—Ç–µ–ª–ª—ã,
–≤–æ–ª—à–µ–±–Ω—ã—Ö –ø–ª–æ–¥–æ–≤, —á—Ç–æ —Ä–∞—Å—Ç—É—Ç –ª–∏—à—å –≤ –ø–µ—â–µ—Ä–µ –î—Ä–∞–∫–æ–Ω–∞ –ü–ª–∞—Å–∏–¥—É—Å–∞–∫—Å. –ù–µ–∫–æ–≥–¥–∞ –¥—Ä–∞–∫–æ–Ω –æ–±–º–µ–Ω–∏–≤–∞–ª
–∏—Ö –Ω–∞ –ø–æ–¥–Ω–æ—à–µ–Ω–∏—è, –Ω–æ —Å —Ç–µ—Ö –ø–æ—Ä –∫–∞–∫ –∏—Å—á–µ–∑ —Å—Ç–∞—Ä—ã–π –≤–æ–ª—Ö–≤, —Å—Ç–∞–≤—à–∏–π —Ö—Ä–∞–Ω–∏—Ç–µ–ª–µ–º –¥–æ–≥–æ–≤–æ—Ä–∞,
–ü–ª–∞—Å–∏–¥—É—Å–∞–∫—Å –æ–∑–ª–æ–±–∏–ª—Å—è –∏ –∑–∞–ø–µ—Ä –ø–ª–æ–¥—ã –≤ —Å–≤–æ—ë–º –ª–æ–≥–æ–≤–µ, –æ–∫—É—Ç–∞–≤ –≥–æ—Ä—É –æ–≥–Ω—ë–º –∏ —Å—Ç—Ä–∞—Ö–æ–º.

–¢–µ–ø–µ—Ä—å –æ—Ç–≤–∞–∂–Ω—ã–µ —Å–µ—Ä–¥—Ü–∞ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è —É –≤—Ä–∞—Ç –¥–µ—Ä–µ–≤–Ω–∏. –ö–∞–∂–¥—ã–π ‚Äî —Å–æ —Å–≤–æ–∏–º –ø—Ä–æ—à–ª—ã–º,
—Å–≤–æ–∏–º –æ—Ä—É–∂–∏–µ–º –∏ —Å–≤–æ–µ–π –ø—Ä–∏—á–∏–Ω–æ–π –∏–¥—Ç–∏:

- –†—ã—Ü–∞—Ä—å ‚Äî –∑–∞—â–∏—Ç–Ω–∏–∫ –ø—Ä–∏—Å—è–≥–∏, —á—å–∏ –¥–æ—Å–ø–µ—Ö–∏ –ø–æ–º–Ω—è—Ç –Ω–µ –æ–¥–Ω—É –±–∏—Ç–≤—É –∏ —á—å–∏ –¥–æ—Å–ø–µ—Ö–∏
—Å–ø–æ—Å–æ–±–Ω—ã –≤—ã—Å—Ç–æ—è—Ç—å —Ç—è–∂–µ–ª—ã–π —É–¥–∞—Ä.
- –î—Ä–æ–≤–æ—Å–µ–∫ ‚Äî —Å–∏–ª–∞—á —Å —Ç–æ–ø–æ—Ä–æ–º, –≤—ã—Ä–æ—Å—à–∏–π –≤ –ª–µ—Å–∞—Ö –∏ –∑–Ω–∞—é—â–∏–π, –∫–∞–∫ —Ä—É–±–∏—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ –¥–µ—Ä–µ–≤—å—è. 
- –£–±–∏–π—Ü–∞ ‚Äî —Ç–µ–Ω—å –≤ –∫–∞–ø—é—à–æ–Ω–µ, —á—Ç–æ –ø–ª–∞—Ç–∏—Ç –¥–æ–ª–≥ —Å—Ç–∞—Ä–æ–π –∫–ª—è—Ç–≤—ã, –∑–Ω–∞—é—â–∏–π –±–æ–ª–µ–≤—ã–µ –º–µ—Å—Ç–∞ 
—Ä–∞–∑–Ω—ã—Ö —á—É–¥–∏—â.
- –ú–∞–≥ ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–π —É—á–µ–Ω–∏–∫, —Å–ø–æ—Å–æ–±–Ω—ã–π –∏—Å–ø—É—Å–∫–∞—Ç—å –ø–ª–∞–º—è, –ø—Ä–æ–ø–∞–≤—à–µ–≥–æ –≤–æ–ª—Ö–≤–∞, 
–∏—â—É—â–∏–π –Ω–µ —Ç–æ–ª—å–∫–æ —Ñ—Ä—É—Ç–µ–ª–ª—É, –Ω–æ –∏ –ø—Ä–∞–≤–¥—É.
- –õ—É—á–Ω–∏–∫ ‚Äî –º–µ—Ç–∫–∏–π –≥–ª–∞–∑, —á—Ç–æ –Ω–µ —Ä–∞–∑ —Å–ø–∞—Å–∞–ª –¥–µ—Ä–µ–≤–Ω—é –æ—Ç –≤–æ–ª–∫–æ–≤ –∏ —Ä–∞–∑–±–æ–π–Ω–∏–∫–æ–≤, 
–Ω–æ –∏ –º–∞—Å—Ç–µ—Ä —Å—Ç—Ä–µ–ª—å–±—ã, —Å–ø–æ—Å–æ–±–Ω—ã–π –≤—ã–ø—É—Å–∫–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–µ–ª –∑–∞ —Ä–∞–∑.
- –ê—Ä–±–∞–ª–µ—Ç—á–∏–∫ ‚Äî —Å—Ç—Ä–µ–ª–æ–∫, —á—å–∏ –±–æ–ª—Ç—ã –Ω–µ —Ä–∞–∑ –ø–æ–ø–∞–¥–∞–ª–∏ –≤ —Å–µ—Ä–¥—Ü–∞ –≤—Ä–∞–≥–æ–≤, 
–∏–º–µ—é—â–∏–π –≤ –∑–∞–ø–∞—Å–µ –±–æ–ª—Ç—ã, —Å–ø–æ—Å–æ–±–Ω—ã–µ —Ä–∞–∑—Ä—É—à–∞—Ç—å —Å—Ç–µ–Ω—ã.
- –ö–æ–ø–µ–π—â–∏–∫ ‚Äî —Å—Ç—Ä–∞–∂ –≥—Ä–∞–Ω–∏—Ü, —á—å—è –ø–∏–∫–∞ –Ω–µ –¥—Ä–æ–∂–∏—Ç –¥–∞–∂–µ –ø–µ—Ä–µ–¥ –¥—Ä–∞–∫–æ–Ω—å–∏–º –∫–ª—ã–∫–æ–º.

–ö—Ç–æ –∏–∑ –Ω–∏—Ö –ø–æ–≤–µ–¥—ë—Ç –æ—Ç—Ä—è–¥ –≤ –ø–ª–∞–º–µ–Ω–Ω—É—é –ø–µ—â–µ—Ä—É?
–í—ã–±–µ—Ä–∏ —Å–≤–æ–µ–≥–æ –≥–µ—Ä–æ—è ‚Äî –∏ –≤ –ø—É—Ç—å!"""


def choose_character():
    print("[!] –í—ã–±–µ—Ä–∏—Ç–µ –≥–µ—Ä–æ—è:")
    print("[1] –†—ã—Ü–∞—Ä—å")
    print("[2] –î—Ä–æ–≤–æ—Å–µ–∫")
    print("[3] –ú–∞–≥")
    print("[4] –£–±–∏–π—Ü–∞")
    print("[5] –õ—É—á–Ω–∏–∫")
    print("[6] –ê—Ä–±–∞–ª–µ—Ç—á–∏–∫")
    print("[7] –ö–æ–ø–µ–π—â–∏–∫")

    while (choice := input("[SELECT] –í–∞—à –≤—ã–±–æ—Ä (1-7): ").strip()) not in [
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
    ]:
        print("[!] –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤–≤–æ–¥.")

    return choice


def story_intro():
    while True:
        a = input("[>] –ü—Ä–æ—á–∏—Ç–∞—Ç—å –ø—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—é? (y/n): ").lower()
        if a == "y":
            print("‚úçÔ∏èStory tailing:")
            custom_output(story)
            print("=" * 70)
            break
        elif a == "n":
            break
        else:
            print(
                "[!] –ù–µ–≤–µ—Ä–Ω—ã–π –≤–≤–æ–¥. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ 'y' –∏–ª–∏ 'n'"
            )


def start():
    story_intro()

    choice = choose_character()
    factory = CharacterFactory(custom_print=custom_output)
    hero = factory.create_character(choice)

    # –°–æ–∑–¥–∞—ë–º –¥—Ä–∞–∫–æ–Ω–∞
    dragon = Dragon(
        name="–ü–ª–∞—Å–∏–¥—É—Å–∞–∫—Å",
        max_health=200,
        health=200,
        shield=20,
        claw_damage=18,
        tail_damage=22,
        fire_breath_damage=28,
        ability_chance=0.25,
    )
    dragon_manager = DragonManager(dragon, custom_print=custom_output)

    battle_loop(hero, dragon, dragon_manager)


def show_status(hero, dragon):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª–æ—Å—ã –∑–¥–æ—Ä–æ–≤—å—è –∏ –º–∞–Ω—ã."""
    print("=" * 70)
    print_health_bar(str(hero), hero.health, hero.max_health, hero.shield)
    if hasattr(hero, "mana"):
        print(f"–ú–∞–Ω–∞: {hero.mana}")
    print_health_bar(str(dragon), dragon.health, dragon.max_health, dragon.shield)
    print("=" * 70)


def get_available_weapons(hero):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–º—ë–Ω –æ—Ä—É–∂–∏–π –≥–µ—Ä–æ—è."""
    return list(hero._weapons_manager._weapons.keys())


def player_turn(hero):
    """–•–æ–¥ –∏–≥—Ä–æ–∫–∞: –≤—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏—è."""
    while True:
        print("[SELECT] –í–∞—à —Ö–æ–¥! –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:")
        print("[1] –ê—Ç–∞–∫–æ–≤–∞—Ç—å")
        print("[2] –°–º–µ–Ω–∏—Ç—å –æ—Ä—É–∂–∏–µ")
        print("[3] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å")
        print("[4] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–µ–ª—å–µ")

        choice = input("[SELECT] –í–∞—à –≤—ã–±–æ—Ä (1-4): ").strip()
        print("=" * 70)

        if choice == "1":
            return "attack"

        elif choice == "2":
            weapons = get_available_weapons(hero)
            if len(weapons) <= 1:
                print("*–£ –≤–∞—Å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –æ—Ä—É–∂–∏–µ!*")
                continue
            print("–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ—Ä—É–∂–∏—è:")
            for i, w in enumerate(weapons, 1):
                print(f"{i}. {w}")
            try:
                w_choice = int(input("–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä—É–∂–∏–µ: ")) - 1
                if 0 <= w_choice < len(weapons):
                    print("‚úçÔ∏èStory tailing:")
                    hero.switch_weapon(weapons[w_choice])
                else:
                    print("*–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä.*")
            except ValueError:
                print("*–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ.*")
            continue  # –æ—Å—Ç–∞—ë–º—Å—è –≤ –º–µ–Ω—é

        elif choice == "3":
            if hero.can_use_ability():
                return "ability"
            continue

        elif choice == "4":
            print("[üçº] –ó–µ–ª—å—è:")
            print("[1] –õ–µ—á–µ–±–Ω–æ–µ –∑–µ–ª—å–µ")
            if hasattr(hero, "mana"):
                print("[2] –ó–µ–ª—å–µ –º–∞–Ω—ã")
            potion_choice = input(
                "[SELECT] –í—ã–±–µ—Ä–∏—Ç–µ –∑–µ–ª—å–µ (1"
                + (", 2" if hasattr(hero, "mana") else "")
                + "): "
            ).strip()
            print("=" * 70)
            if potion_choice == "1":
                print("‚úçÔ∏èStory tailing:")
                hero.use_potion("–õ–µ—á–µ–±–Ω–æ–µ –∑–µ–ª—å–µ")
                print("=" * 70)
            elif potion_choice == "2" and hasattr(hero, "mana"):
                print("‚úçÔ∏èStory tailing:")
                hero.use_potion("–≠–ª–∏–∫—Å–∏—Ä –º–∞–Ω—ã")
                print("=" * 70)
            else:
                print("*–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä.*")
            continue  # –æ—Å—Ç–∞—ë–º—Å—è –≤ –º–µ–Ω—é

        else:
            print("*–í–≤–µ–¥–∏—Ç–µ 1, 2, 3 –∏–ª–∏ 4.*")


def ending_heroic_victory(hero, dragon):
    custom_output(f"\nüåü{str(hero)} —Å—Ç–æ–∏—Ç –Ω–∞–¥ –ø–æ–≤–µ—Ä–∂–µ–Ω–Ω—ã–º {str(dragon)}!")
    custom_output("–ï–≥–æ –∫–ª–∏–Ω–æ–∫ –Ω–µ –¥—Ä–æ–≥–Ω—É–ª, –∞ —Å–µ—Ä–¥—Ü–µ ‚Äî –Ω–µ —Å–∂–∞–ª–æ—Å—å.")
    custom_output("–î–µ—Ä–µ–≤–Ω—è —Å–ø–∞—Å–µ–Ω–∞. –ü–µ—Å–Ω–∏ –æ –ø–æ–¥–≤–∏–≥–µ –±—É–¥—É—Ç –ø–µ—Ç—å—Å—è –≤–µ–∫–∞–º–∏!")
    custom_output("\nüéñÔ∏è–ö–û–ù–ï–¶: –ù–ï–ü–û–ë–ï–î–ò–ú–´–ô –ì–ï–†–û–ô")


def ending_cursed_victory(hero, dragon):
    custom_output(f"\nüíÄ{str(hero)} —Å—Ç–æ–∏—Ç –Ω–∞–¥ —Ç–µ–ª–æ–º {str(dragon)}... –Ω–æ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫.")
    custom_output("–ò–∑ —Ä–∞–Ω –¥—Ä–∞–∫–æ–Ω–∞ –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è —á—ë—Ä–Ω—ã–π –¥—ã–º –∏ –≤–ø–∏–≤–∞–µ—Ç—Å—è –≤ –≥–µ—Ä–æ—è.")
    custom_output("–ë–æ–ª—å –≤ –µ–≥–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–∞–Ω–∞—Ö —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ–≤—ã–Ω–æ—Å–∏–º–æ–π ‚Äî –∫—Ä–æ–≤—å —Ç–µ—á—ë—Ç —Å–∏–ª—å–Ω–µ–µ.")
    custom_output("–û–Ω –ø–æ–±–µ–¥–∏–ª... –Ω–æ —Ç–µ–ø–µ—Ä—å –Ω–æ—Å–∏—Ç –≤ –ø—Ä–æ–∫–ª—è—Ç—å–µ –ë–æ–≥–æ–≤.")
    custom_output("\nüëÅÔ∏è–ö–û–ù–ï–¶: –ü–û–ë–ï–î–ò–¢–ï–õ–¨ –°–¢–ê–õ –ü–†–û–ö–õ–Ø–¢–´–ú")


def ending_pyrhic_victory(hero, dragon):
    custom_output(f"\nü©∏{str(hero)} –ø–∞–¥–∞–µ—Ç –Ω–∞ –∫–æ–ª–µ–Ω–∏ —Ä—è–¥–æ–º —Å —Ç–µ–ª–æ–º {str(dragon)}!")
    custom_output("–†–∞–Ω–∞ –Ω–∞ –±–æ–∫—É –∫—Ä–æ–≤–æ—Ç–æ—á–∏—Ç, –¥–æ—Å–ø–µ—Ö–∏ –≤ –ø—ã–ª–∏ –∏ –∫—Ä–æ–≤–∏...")
    custom_output("–î–µ—Ä–µ–≤–Ω—è —Å–ø–∞—Å–µ–Ω–∞... –Ω–æ —Å–º–æ–∂–µ—Ç –ª–∏ –≥–µ—Ä–æ–π –¥–æ–π—Ç–∏ –¥–æ–º–æ–π?")
    custom_output("\n‚ö∞Ô∏è–ö–û–ù–ï–¶: –ü–û–ë–ï–î–ê –¶–ï–ù–û–ô –ñ–ò–ó–ù–ò")


def ending_tragic_defeat(hero, dragon):
    custom_output(f"\nüî•{str(dragon)} –≤–∑–º–∞—Ö–∏–≤–∞–µ—Ç –∫—Ä—ã–ª—å—è–º–∏ –Ω–∞–¥ –±–µ–∑–¥—ã—Ö–∞–Ω–Ω—ã–º —Ç–µ–ª–æ–º {str(hero)}.")
    custom_output("–ü–ª–∞–º—è –ø–æ–∂–∏—Ä–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–ª–µ–¥—ã –±–æ—è.")
    custom_output("–î–µ—Ä–µ–≤–Ω—è –æ–±—Ä–µ—á–µ–Ω–∞... –ù–∏–∫—Ç–æ –Ω–µ –æ—Å–º–µ–ª–∏—Ç—Å—è –±—Ä–æ—Å–∏—Ç—å –≤—ã–∑–æ–≤ –¥—Ä–∞–∫–æ–Ω—É —Å–Ω–æ–≤–∞.")
    custom_output("\nüåë–ö–û–ù–ï–¶: –ü–õ–ê–ú–Ø –ü–û–ë–ï–î–ò–õ–û")



def battle_loop(hero, dragon, enemy_manager):
    """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –±–æ—è."""
    print("‚öîÔ∏è –ë–æ–π –Ω–∞—á–∞–ª—Å—è!\n")
    while hero.is_alive() and dragon.is_alive():
        show_status(hero, dragon)

        # –•–æ–¥ –∏–≥—Ä–æ–∫–∞
        action = player_turn(hero)
        print("‚úçÔ∏èStory tailing:")
        if action == "attack":
            hero.attack(dragon)
        elif action == "ability":
            hero.use_ability(dragon)

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –ø–æ—Å–ª–µ —Ö–æ–¥–∞ –∏–≥—Ä–æ–∫–∞
        hero.process_effect()
        dragon.process_effect()

        if not dragon.is_alive():
            has_hero_effect = any(str(effect) == "–û–≥–Ω–µ–Ω–Ω–æ–µ –ø–ª–∞–º—è" for effect in hero._active_effect)
            if has_hero_effect:
                ending_cursed_victory(hero, dragon)
            elif hero.health <= hero.max_health * 0.33:
                ending_pyrhic_victory(hero, dragon)
            else:
                ending_heroic_victory(hero, dragon)
            break

        # –•–æ–¥ –¥—Ä–∞–∫–æ–Ω–∞
        enemy_manager.next_turn(hero)

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –ø–æ—Å–ª–µ —Ö–æ–¥–∞ –¥—Ä–∞–∫–æ–Ω–∞
        hero.process_effect()
        dragon.process_effect()

        if not hero.is_alive():
            ending_tragic_defeat(hero, dragon)
            break

    print("\nüîö–ë–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω.")
